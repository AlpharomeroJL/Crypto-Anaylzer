@startuml architecture_internal
title Internal Architecture — Four Stages, One Database

database "SQLite\n(dex_data.sqlite)" as DB

package "Ingestion\n(ingest API only for poll)" {
  component "cli/poll → ingest\n(get_poll_context,\nrun_one_cycle)" as Poller
  component "Spot chain\n(Coinbase → Kraken)" as SpotChain
  component "DEX chain\n(Dexscreener)" as DexChain
  component "DbWriter" as DbWriter
  Poller --> SpotChain
  Poller --> DexChain
  SpotChain --> DbWriter
  DexChain --> DbWriter
  DbWriter --> DB : write snapshots,\nspot prices, health
}

package "Materialization" {
  component "Bar builder\n(bars_{freq})" as BarBuilder
  component "factor_materialize\n(opt)" as FactorMat
  component "regime_materialize\n(opt, Phase 3)" as RegimeMat
  BarBuilder --> DB : read snapshots\nwrite bars_*
  FactorMat --> DB : factor_model_runs,\nresidual_returns
  RegimeMat --> DB : regime_runs,\nregime_states
}

package "Modeling" {
  component "data / features\nfactors / regimes\nsignals" as Model
  component "optimizer\nwalk_forward" as Opt
  component "experiments\nregistry" as Exp
  Model --> DB : read bars, spot
  Opt --> Model
  Exp --> DB : read/write runs
}

package "Presentation" {
  component "Reports\n(report_*.py)" as Reports
  component "Streamlit\n(read_api + ingest\n.get_provider_health)" as UI
  component "REST API\n(FastAPI)" as API
  Reports --> DB
  UI --> DB
  API --> DB
}

DB --> BarBuilder : snapshots
DB --> Model : bars, spot
DB --> Reports : data
DB --> UI : data
DB --> API : data

note bottom of DB
  Single source of truth.
  Stages can run independently.
end note

@enduml
